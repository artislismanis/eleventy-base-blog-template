import fs from 'fs/promises';
import { minify } from 'html-minifier-terser';
import { processFiles } from '../utils/file-processor.mjs';

export async function minifyHTML(outputDir = '_site', userOptions = {}) {
	const defaultOptions = {
		collapseBooleanAttributes: true,
		collapseWhitespace: true,
		conservativeCollapse: false,
		decodeEntities: true,
		html5: true,
		includeAutoGeneratedTags: false,
		minifyCSS: true,
		minifyJS: true,
		preserveLineBreaks: false,
		preventAttributesEscaping: true,
		removeAttributeQuotes: true,
		removeComments: true,
		removeEmptyAttributes: true,
		removeOptionalTags: false,
		removeRedundantAttributes: true,
		removeScriptTypeAttributes: true,
		removeStyleLinkTypeAttributes: true,
		sortAttributes: true,
		sortClassName: true,
		useShortDoctype: true,
	};

	const options = { ...defaultOptions, ...userOptions };

	return processFiles({
		pattern: `${outputDir}/**/*.html`,
		outputDir,
		taskName: 'HTML Minification',
		errorTip: 'Check if HTML is valid and properly formed. Invalid HTML can cause minification to fail.',
		processor: async (file) => {
			const html = await fs.readFile(file, 'utf-8');
			const originalSize = Buffer.byteLength(html, 'utf8');
			const minified = await minify(html, options);
			const minifiedSize = Buffer.byteLength(minified, 'utf8');

			await fs.writeFile(file, minified);

			const savings = ((1 - minifiedSize / originalSize) * 100).toFixed(1);

			return {
				message: ` (${savings}% smaller)`,
				stats: { originalSize, minifiedSize },
			};
		},
		calculateStats: (results) => {
			const totalOriginal = results.reduce((sum, r) => sum + r.stats.originalSize, 0);
			const totalMinified = results.reduce((sum, r) => sum + r.stats.minifiedSize, 0);
			const totalSavings = ((1 - totalMinified / totalOriginal) * 100).toFixed(1);

			return {
				'total reduction': `${totalSavings}% (${(totalOriginal / 1024).toFixed(1)} KB â†’ ${(totalMinified / 1024).toFixed(1)} KB)`,
			};
		},
	});
}
