import path from 'path';
import fs from 'fs/promises';

import { glob } from 'glob';
import { minify } from 'html-minifier-terser';

export async function minifyHTML(outputDir = '_site', userOptions = {}) {
	console.log('\nðŸ“¦ Minifying HTML...\n');

	const htmlFiles = await glob(`${outputDir}/**/*.html`);

	if (htmlFiles.length === 0) {
		console.log('âš ï¸  HTML Minify: No HTML files found to process');
		return;
	}

	const defaultOptions = {
		collapseBooleanAttributes: true,
		collapseWhitespace: true,
		conservativeCollapse: false,
		decodeEntities: true,
		html5: true,
		includeAutoGeneratedTags: false,
		minifyCSS: true,
		minifyJS: true,
		preserveLineBreaks: false,
		preventAttributesEscaping: true,
		removeAttributeQuotes: true,
		removeComments: true,
		removeEmptyAttributes: true,
		removeOptionalTags: false,
		removeRedundantAttributes: true,
		removeScriptTypeAttributes: true,
		removeStyleLinkTypeAttributes: true,
		sortAttributes: true,
		sortClassName: true,
		useShortDoctype: true,
	};

	const options = { ...defaultOptions, ...userOptions };

	let totalOriginalSize = 0;
	let totalMinifiedSize = 0;
	let successCount = 0;
	let errorCount = 0;
	const errors = [];

	for (const file of htmlFiles) {
		try {
			const html = await fs.readFile(file, 'utf-8');
			const originalSize = Buffer.byteLength(html, 'utf8');
			const minified = await minify(html, options);
			const minifiedSize = Buffer.byteLength(minified, 'utf8');

			await fs.writeFile(file, minified);

			totalOriginalSize += originalSize;
			totalMinifiedSize += minifiedSize;

			const savings = ((1 - minifiedSize / originalSize) * 100).toFixed(1);
			console.log(`âœ“ ${path.relative(outputDir, file)} (${savings}% smaller)`);
			successCount++;
		} catch (error) {
			errorCount++;
			errors.push({
				file: path.relative(outputDir, file),
				error: error.message,
			});
			console.error(`âœ— ${path.relative(outputDir, file)}: ${error.message}`);
		}
	}

	const totalSavings = (
		(1 - totalMinifiedSize / totalOriginalSize) *
		100
	).toFixed(1);
	console.log(
		`\nâœ“ HTML minified: ${successCount}/${htmlFiles.length} pages, ${totalSavings}% reduction (${(totalOriginalSize / 1024).toFixed(1)} KB â†’ ${(totalMinifiedSize / 1024).toFixed(1)} KB)${errorCount > 0 ? `, ${errorCount} failed` : ''}\n`,
	);

	if (errorCount > 0) {
		console.error('\nâŒ HTML Minification Errors:');
		errors.forEach(({ file, error }) => {
			console.error(`   ${file}: ${error}`);
		});
		console.error(
			'\nTip: Check if HTML is valid and properly formed. Invalid HTML can cause minification to fail.',
		);
		throw new Error(
			`HTML minification failed for ${errorCount} file(s). See errors above.`,
		);
	}
}
